<h2>Step-1</h2>
<div class="answer"> <p> <b>Program Plan:</b> </p> <p>• Declare a function runner which takes one value as arguments which is the function for the threads.</p> <p>• Define the main function from where the execution of the function begins. </p> <p>• Iterate the for loop NUM_THREADS times to create the threads. </p> <p>• Iterate the for loop NUM_THREADS times to wait for the threads to exit</p> <p>• Declare the function runner which is the starting function for the threads. </p> <p>• In header file 3-20PP.h allocation and releasing of the bitmap and pid is done. </p> <p>• In source file 3-20PP.c methods are implemented. </p> </div>
<h2>Step-2</h2>
<div class="answer"> <p> <b>Program:</b> </p> <p>/*********************************************************** Modifying a program by using Pthreads mutex locks so * * that process identifier is safe from the race conditions* **********************************************************/ </p> <p> <b>3-20PP.h</b> </p> <p>#ifndef API_3_20PP_H</p> <p>#define API_3_20PP_H</p> <p>// Allocate the bitmap</p> <p>extern int allocate_map<b>(</b>void<b>);</b></p> <p>// Release the bitmap</p> <p>extern void release_map<b>(</b>void<b>);</b></p> <p>// Allocate a pid</p> <p>extern int allocate_pid<b>(</b>void<b>);</b></p> <p>// Release a pid</p> <p>extern void release_pid<b>(</b>int pid<b>);</b></p> <p>#endif</p> </div>
<h2>Step-3</h2>
<div class="answer"> <p> <b>3-20PP.c</b> </p> <p>#include <stdio.h></p> <p>#include <stdlib.h></p> <p>#include "3-20PP.h"</p> <p>Define the value of minimum pid, maximum pid and number of bits at position in the bitmap.</p> <p>// Minimum value of pid</p> <p>#define MIN_PID 300</p> <p>// Maximum value of pid</p> <p>#define MAX_PID 5000</p> <p>// The number of bits at a position in the bitmap</p> <p>#define NUM_BITS 8</p> <p>Initialize the size. Index, offset and process id of bitmap. All variable are declared as static as there value is not changing throughout the program.</p> <p>// The bitmap of pids</p> <p>static unsigned char <b>*</b>s_bitmap <b>=</b> <b>NULL</b><b>;</b></p> <p>// The size of the bitmap</p> <p>static int s_size <b>=</b> <b>-</b>1<b>;</b></p> <p>// The current index into the bitmap</p> <p>static int s_index <b>=</b> <b>-</b>1<b>;</b></p> <p>// The current offset into the index of the bitmap</p> <p>static int s_offset <b>=</b> <b>-</b>1<b>;</b></p> <p>// The last assigned pid</p> <p>static int s_pid <b>=</b> <b>-</b>1<b>;</b></p> <p>Allocate the map for process ids calculating the size of bitmap that is required.</p> <p>//Allocate the map for the pids. </p> <p>int allocate_map<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap need to be allocated?</p> <p> <b>if</b> <b>(!</b>s_bitmap<b>)</b> </p> <p> <b>{</b></p> <p> // Calculate the size of the bitmap required</p> <p> s_size <b>=</b> <b>(</b>int<b>)</b> <b>((</b>double<b>)</b> <b>(</b>MAX_PID</p> <p> <b>-</b> MIN_PID <b>+</b> 1</p> <p> <b>+</b> NUM_BITS <b>-</b> 1<b>)</b></p> <p> <b>/</b> NUM_BITS<b>);</b></p> <p> </p> <p> // Allocate the bitmap</p> <p> s_bitmap <b>=</b> <b>(</b>__typeof__<b>(</b>s_bitmap<b>))</b> malloc<b>(</b>s_size<b>);</b></p> <p> <b>}</b></p> <p> </p> <p> // Does the bitmap exist?</p> <p> </div>
<h2>Step-4</h2>
<div class="answer"> <b>if</b> <b>(</b>s_bitmap<b>)</b> </p> <p> <b>{</b></p> <p> // Initialize the variables</p> <p> s_index <b>=</b> s_offset <b>=</b> 0<b>;</b></p> <p> s_pid <b>=</b> MIN_PID <b>-</b> 1<b>;</b></p> <p> <b>return</b> 1<b>;</b></p> <p> <b>}</b> <b>else</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b> </p> <p>//Release the bitmap </p> <p>void release_map<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap exist?</p> <p> <b>if</b> <b>(</b>s_bitmap<b>)</b> </p> <p> <b>{</b></p> <p> // Free it & deinitialize the variables</p> <p> free<b>(</b>s_bitmap<b>);</b></p> <p> s_bitmap <b>=</b> <b>NULL</b><b>;</b></p> <p> s_index <b>=</b> s_offset <b>=</b> s_pid <b>=</b> <b>-</b>1<b>;</b></p> <p> <b>}</b></p> <p> <b>}</b> </p> <p>Allocate a pid in a range. It assumes that bitmap is valid. While loop is used to execute the condition until pindex is less then size. </p> <p>static int allocate_pid_range<b>(</b>int <b>*</b>pindex<b>,</b></p> <p> const int size<b>)</b></p> <p> <b>{</b> </p> <p> // While the index is less than the size</p> <p> <b>while</b> <b>(*</b>pindex <b><</b> size<b>)</b> </p> <p> <b>{</b></p> <p> // While the offset within an element</p> <p> // is less than the number of bits</p> <p> <b>while</b> <b>(</b>s_offset <b><</b> NUM_BITS<b>)</b> </p> <p> <b>{</b> </p> <p> // Increment the pid</p> <p> s_pid<b>++;</b></p> <p> </p> <p> // Did the pid exceed the maximum?</p> <p> <b>if</b> <b>(</b>s_pid <b>></b> MAX_PID<b>)</b> </p> <p> <b>{</b></p> <p> // Reset the pid and the offset</p> <p> s_pid <b>=</b> MIN_PID <b>-</b> 1<b>;</b></p> <p> s_offset <b>=</b> 0<b>;</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b></p> <p> // Is the offset free?</p> <p> <b>if</b> <b>(!(</b>s_bitmap<b>[*</b>pindex<b>]</b></p> <p> <b>&</b> <b>(</b>1u <b><<</b> s_offset<b>)))</b> </p> <p> <b>{</b></p> <p> // Fill the offset</p> <p> s_bitmap<b>[*</b>pindex<b>]</b> <b>|=</b> 1u <b><<</b> s_offset<b>;</b></p> <p> </p> <p> // Increment the offset</p> <p> s_offset<b>++;</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b></p> <p> </p> <p> // Increment the offset</p> <p> s_offset<b>++;</b></p> <p> <b>}</b></p> <p> </p> <p> // Reset the offset</p> <p> s_offset <b>=</b> 0<b>;</b></p> <p> </p> <p> // Increment the index</p> <p> <b>(*</b>pindex<b>)++;</b></p> <p> <b>}</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b> </p> <p>In allocate_pid function allocate the pid from current index to size of bitmap. If pid is allocated then ret value will be 0 otherwise less than 0.</p> <p>//Allocate a pid. </p> <p>int allocate_pid<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap exist?</p> <p> <b>if</b> <b>(</b>s_bitmap<b>)</b> </p> <p> <b>{</b></p> <p> // Try to allocate a pid from the current index</p> <p> // to the size of the bitmap</p> <p> int index <b>=</b> s_index<b>;</b></p> <p> int ret <b>=</b> allocate_pid_range<b>(&</b>index<b>,</b> s_size<b>);</b></p> <p> </p> <p> // Could a pid be allocated?</p> <p> <b>if</b> <b>(</b>ret <b><</b> 0<b>)</b> </p> <p> <b>{</b></p> <p> // Reset the index and try again</p> <p> index <b>=</b> 0<b>;</b></p> <p> ret <b>=</b> allocate_pid_range<b>(&</b>index<b>,</b> s_index<b>);</b></p> <p> <b>}</b></p> <p> // Was a pid successfully allocated?</p> <p> <b>if</b> <b>(</b>ret <b>==</b> 0<b>)</b> </p> <p> <b>{</b></p> <p> // Update the index</p> <p> s_index <b>=</b> index<b>;</b></p> <p> // Return the pid</p> <p> <b>return</b> s_pid<b>;</b></p> <p> </div>
<h2>Step-5</h2>
<div class="answer"> <b>}</b></p> <p> <b>}</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b> </p> <p>//Release an allocated pid. </p> <p>void release_pid<b>(</b>int pid<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap exist and is the pid valid?</p> <p> <b>if</b> <b>(</b>s_bitmap <b>&&</b> pid <b>>=</b> MIN_PID <b>&&</b> pid <b><=</b> MAX_PID<b>)</b> </p> <p> <b>{</b></p> <p> // Subtract MIN_PID so it can be</p> <p> // used to access the bitmap</p> <p> pid <b>-=</b> MIN_PID<b>;</b></p> <p> </p> <p> // Clear the entry for the pid in the bitmap</p> <p> s_bitmap<b>[</b>pid <b>/</b> NUM_BITS<b>]</b> </p> <p> <b>&=</b> <b>~(</b>1u <b><<</b> <b>(</b>pid <b>%</b> NUM_BITS<b>));</b></p> <p> <b>}</b></p> <p> <b>}</b> </p> </div>
<h2>Step-6</h2>
<div class="answer"> <p> <b>13258-5-36PP.c</b> </p> <p>Include a header file for performing the operation. </p> <p>#include <stdio.h></p> <p>#include <pthread.h></p> <p>#include <unistd.h></p> <p>#include <stdlib.h></p> <p>#include <time.h></p> <p>#include "3-20PP.h"</p> <p>// The number of threads that will be created</p> <p>const int NUM_THREADS <b>=</b> 100<b>;</b></p> <p>// The maximum amount of time a thread can sleep for</p> <p>const int MAX_SLEEP_TIME <b>=</b> 10<b>;</b></p> <p>Declare a function runner which takes one value as arguments which is the function for the threads.</p> <p>void <b>*</b>runner<b>(</b>void <b>*</b>param<b>);</b></p> <p>Define the main function from where the execution of the function begins. </p> <p>int main<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // The pthread attributes</p> <p> pthread_attr_t attr<b>;</b></p> <p> // An array for storing the thread ids</p> <p> pthread_t thread_ids<b>[</b>NUM_THREADS<b>];</b></p> <p> // Used to index into the thread_ids array</p> <p> int index<b>;</b></p> <p> // The value returned by functions</p> <p> int ret<b>;</b></p> <p> // Allocate a map of pids</p> <p> ret <b>=</b> allocate_map<b>();</b></p> <p>Check the condition using if statement whether map of pid is equal to 1. </p> <p> <b>if</b> <b>(</b>ret <b>!=</b> 1<b>)</b> </p> <p> <b>{</b></p> <p> printf<b>(</b>"allocate_map didn't work - %d\n"<b>,</b> ret<b>);</b></p> <p> <b>return</b> 1<b>;</b></p> <p> <b>}</b></p> <p> // Initialize the random number generator</p> <p> // with the current time</p> <p> srand<b>(</b>time<b>(</b><b>NULL</b><b>));</b></p> <p> // Initialize pthreads</p> <p> <b>if</b> <b>(</b>pthread_attr_init<b>(&</b>attr<b>)</b> <b>!=</b> 0<b>)</b> </p> <p> <b>{</b></p> <p> fputs<b>(</b>"pthread_attr_init didn't work\n"<b>,</b></p> <p> stdout<b>);</b></p> <p> // Release the map of pids</p> <p> release_map<b>();</b></p> <p> <b>return</b> 2<b>;</b></p> <p> <b>}</b></p> <p> printf<b>(</b>"Creating %d threads\n"<b>,</b> NUM_THREADS<b>);</b></p> <p>Iterate the for loop NUM_THREADS times to create the threads. </p> <p> <b>for</b> <b>(</b>index <b>=</b> 0<b>;</b> index <b><</b> NUM_THREADS<b>;</b> index<b>++)</b> </p> <p> <b>{</b></p> <p> // Create a thread</p> <p> ret <b>=</b> pthread_create<b>(&</b>thread_ids<b>[</b>index<b>],</b> </p> <p> <b>&</b>attr<b>,</b> runner<b>,</b> <b>NULL</b><b>);</b></p> <p>Check the condition using if statement whether ret is equal to 0 or not. </p> <p> <b>if</b> <b>(</b>ret <b>!=</b> 0<b>)</b> </p> <p> <b>{</b></p> <p> </div>
<h2>Step-7</h2>
<div class="answer"> printf<b>(</b>"Couldn't create thread number %d\n"<b>,</b></p> <p> index <b>+</b> 1<b>);</b></p> <p> thread_ids<b>[</b>index<b>]</b> <b>=</b> <b>-</b>1<b>;</b></p> <p> <b>}</b></p> <p> <b>}</b></p> <p> </p> <p>Iterate the for loop NUM_THREADS times to wait for the threads to exit</p> <p> </p> <p> <b>for</b> <b>(</b>index <b>=</b> 0<b>;</b> index <b><</b> NUM_THREADS<b>;</b> index<b>++)</b></p> <p> <b>if</b> <b>(</b>thread_ids<b>[</b>index<b>]</b> <b>>=</b> 0<b>)</b> </p> <p> <b>{</b></p> <p> // Wait for a thread to exit</p> <p> ret <b>=</b> pthread_join<b>(</b>thread_ids<b>[</b>index<b>],</b> </p> <p> <b>NULL</b><b>);</b></p> <p>Checking the condition whether ret is equal to 0 or not. </p> <p> <b>if</b> <b>(</b>ret <b>!=</b> 0<b>)</b></p> <p> printf<b>(</b>"pthread_join didn't work for "</p> <p> "thread id %lx\n"<b>,</b></p> <p> thread_ids<b>[</b>index<b>]);</b></p> <p> <b>}</b></p> <p> // De-initialize pthreads</p> <p> pthread_attr_destroy<b>(&</b>attr<b>);</b></p> <p> // Release the map of pids</p> <p> release_map<b>();</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b> </p> <p>Declare the function runner which is the starting function for the threads. </p> <p>void <b>*</b>runner<b>(</b>void <b>*</b>param<b>)</b></p> <p> <b>{</b> </p> <p> // Allocate a pid</p> <p> int thread_id <b>=</b> allocate_pid<b>();</b></p> <p> printf<b>(</b>"Allocated thread id %d\n"<b>,</b> thread_id<b>);</b></p> <p> // Sleep a random amount of time</p> <p> sleep<b>(</b>rand<b>()</b> <b>%</b> MAX_SLEEP_TIME <b>+</b> 1<b>);</b></p> <p> // Release the pid</p> <p> release_pid<b>(</b>thread_id<b>);</b></p> <p> printf<b>(</b>"Released thread id %d\n"<b>,</b> thread_id<b>);</b></p> <p> // Exit from the thread</p> <p> pthread_exit<b>(</b>0<b>);</b></p> <p> <b>}</b> </p> </div>
<h2>Step-8</h2>
<div class="answer"> <p> <b>Sample Output:</b> </p> <p>Creating 100 threads</p> <p>Allocated thread id 300</p> <p>Allocated thread id 301</p> <p>Allocated thread id 302</p> <p>Allocated thread id 303</p> <p>Allocated thread id 304</p> <p>Allocated thread id 305</p> <p>Allocated thread id 306</p> <p>Allocated thread id 307</p> <p>Allocated thread id 308</p> <p>Allocated thread id 309</p> <p>Allocated thread id 310</p> <p>Allocated thread id 311</p> <p>Allocated thread id 312</p> <p>Allocated thread id 313</p> <p>Allocated thread id 314</p> <p>Allocated thread id 315</p> <p>Allocated thread id 316</p> <p>Allocated thread id 317</p> <p>Allocated thread id 318</p> <p>Allocated thread id 319</p> <p>Allocated thread id 320</p> <p>Allocated thread id 321</p> <p>Allocated thread id 322</p> <p>Allocated thread id 323</p> <p>Allocated thread id 324</p> <p>Allocated thread id 325</p> <p>Allocated thread id 326</p> <p>Allocated thread id 327</p> <p>Allocated thread id 328</p> <p>Allocated thread id 329</p> <p>Allocated thread id 330</p> <p>Allocated thread id 331</p> <p>Allocated thread id 332</p> <p>Allocated thread id 333</p> <p>Allocated thread id 334</p> <p>Allocated thread id 335</p> <p>Allocated thread id 336</p> <p>Allocated thread id 337</p> <p>Allocated thread id 338</p> <p>Allocated thread id 339</p> <p>Allocated thread id 340</p> <p>Allocated thread id 341</p> <p>Allocated thread id 342</p> <p>Allocated thread id 343</p> <p>Allocated thread id 344</p> <p>Allocated thread id 345</p> <p> </div>
<h2>Step-9</h2>
<div class="answer">Allocated thread id 346</p> <p>Allocated thread id 347</p> <p>Allocated thread id 348</p> <p>Allocated thread id 349</p> <p>Allocated thread id 350</p> <p>Allocated thread id 351</p> <p>Allocated thread id 352</p> <p>Allocated thread id 353</p> <p>Allocated thread id 354</p> <p>Allocated thread id 355</p> <p>Allocated thread id 356</p> <p>Allocated thread id 357</p> <p>Allocated thread id 358</p> <p>Allocated thread id 359</p> <p>Allocated thread id 360</p> <p>Allocated thread id 361</p> <p>Allocated thread id 362</p> <p>Allocated thread id 363</p> <p>Allocated thread id 364</p> <p>Allocated thread id 365</p> <p>Allocated thread id 366</p> <p>Allocated thread id 367</p> <p>Allocated thread id 368</p> <p>Allocated thread id 369</p> <p>Allocated thread id 370</p> <p>Allocated thread id 371</p> <p>Allocated thread id 372</p> <p>Allocated thread id 373</p> <p>Allocated thread id 374</p> <p>Allocated thread id 375</p> <p>Allocated thread id 376</p> <p>Allocated thread id 377</p> <p>Allocated thread id 378</p> <p>Allocated thread id 379</p> <p>Allocated thread id 380</p> <p>Allocated thread id 381</p> <p>Allocated thread id 382</p> <p>Allocated thread id 383</p> <p>Allocated thread id 384</p> <p>Allocated thread id 385</p> <p>Allocated thread id 386</p> <p>Allocated thread id 387</p> <p>Allocated thread id 388</p> <p>Allocated thread id 389</p> <p>Allocated thread id 390</p> <p>Allocated thread id 391</p> <p>Allocated thread id 392</p> <p>Allocated thread id 393</p> <p>Allocated thread id 394</p> <p>Allocated thread id 395</p> <p>Allocated thread id 396</p> <p>Allocated thread id 397</p> <p>Allocated thread id 398</p> <p>Allocated thread id 399</p> <p>Released thread id 300</p> <p>Released thread id 322</p> <p>Released thread id 333</p> <p>Released thread id 340</p> <p>Released thread id 350</p> <p>Released thread id 370</p> <p>Released thread id 391</p> <p>Released thread id 305</p> <p>Released thread id 320</p> <p>Released thread id 323</p> <p>Released thread id 345</p> <p>Released thread id 347</p> <p>Released thread id 353</p> <p>Released thread id 361</p> <p>Released thread id 389</p> <p>Released thread id 397</p> <p>Released thread id 311</p> <p>Released thread id 318</p> <p>Released thread id 327</p> <p>Released thread id 335</p> <p>Released thread id 339</p> <p>Released thread id 344</p> <p>Released thread id 346</p> <p>Released thread id 355</p> <p>Released thread id 363</p> <p>Released thread id 368</p> <p>Released thread id 371</p> <p>Released thread id 372</p> <p>Released thread id 383</p> <p>Released thread id 394</p> <p>Released thread id 302</p> <p>Released thread id 312</p> <p>Released thread id 329</p> <p>Released thread id 336</p> <p>Released thread id 343</p> <p>Released thread id 396</p> <p>Released thread id 301</p> <p>Released thread id 304</p> <p>Released thread id 309</p> <p>Released thread id 314</p> <p>Released thread id 342</p> <p>Released thread id 352</p> <p>Released thread id 358</p> <p>Released thread id 360</p> <p>Released thread id 364</p> <p>Released thread id 379</p> <p> </div>
<h2>Step-10</h2>
<div class="answer">Released thread id 382</p> <p>Released thread id 386</p> <p>Released thread id 392</p> <p>Released thread id 306</p> <p>Released thread id 310</p> <p>Released thread id 313</p> <p>Released thread id 341</p> <p>Released thread id 375</p> <p>Released thread id 380</p> <p>Released thread id 307</p> <p>Released thread id 317</p> <p>Released thread id 324</p> <p>Released thread id 337</p> <p>Released thread id 349</p> <p>Released thread id 365</p> <p>Released thread id 366</p> <p>Released thread id 373</p> <p>Released thread id 378</p> <p>Released thread id 381</p> <p>Released thread id 385</p> <p>Released thread id 388</p> <p>Released thread id 398</p> <p>Released thread id 303</p> <p>Released thread id 315</p> <p>Released thread id 325</p> <p>Released thread id 326</p> <p>Released thread id 330</p> <p>Released thread id 348</p> <p>Released thread id 367</p> <p>Released thread id 369</p> <p>Released thread id 374</p> <p>Released thread id 376</p> <p>Released thread id 384</p> <p>Released thread id 390</p> <p>Released thread id 393</p> <p>Released thread id 316</p> <p>Released thread id 321</p> <p>Released thread id 328</p> <p>Released thread id 332</p> <p>Released thread id 334</p> <p>Released thread id 338</p> <p>Released thread id 351</p> <p>Released thread id 356</p> <p>Released thread id 357</p> <p>Released thread id 362</p> <p>Released thread id 387</p> <p>Released thread id 395</p> <p>Released thread id 399</p> <p>Released thread id 308</p> <p>Released thread id 319</p> <p>Released thread id 331</p> <p>Released thread id 354</p> <p>Released thread id 359</p> <p>Released thread id 377</p></div>
