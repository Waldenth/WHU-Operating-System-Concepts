<h2>Step-1</h2>
<div class="answer"> <p> <b>Program Plan:</b> </p> <p>• Make a header file for allocation and release of bitmap.</p> <p>• Make header for allocate and release process id.</p> <p>• Make a main function to allocate and de-allocate bitmap and process id.</p> <p>• Allocate the map for the pids. It will return 1 if unable to allocate pids.</p> <p>• Calculate the size of the bitmap required. Allocate the bitmap.</p> <p>• Release the bitmap. Allocate a pid in a range. It assumes that bitmap is valid. </p> </div>
<h2>Step-2</h2>
<div class="answer"> <p> <b>Program:</b> </p> <p>//Include the header files for performing the operations.</p> <p>#ifndef API_3_20PP_H</p> <p>#define API_3_20PP_H</p> <p>// Allocate the bitmap</p> <p>extern int allocate_map<b>(</b>void<b>);</b></p> <p>// Release the bitmap</p> <p>extern void release_map<b>(</b>void<b>);</b></p> <p>// Allocate a pid</p> <p>extern int allocate_pid<b>(</b>void<b>);</b></p> <p>// Release a pid</p> <p>extern void release_pid<b>(</b>int pid<b>);</b></p> <p>#endif</p> </div>
<h2>Step-3</h2>
<div class="answer"> <p>//Include the header files for performing the operations.</p> <p>#include <stdio.h></p> <p>#include <stdlib.h></p> <p>#include "3-20PP.h"</p> <p>Define the value of minimum pid, maximum pid and number of bits at position in the bitmap.</p> <p>// Minimum value of pid</p> <p>#define MIN_PID 300</p> <p>// Maximum value of pid</p> <p>#define MAX_PID 5000</p> <p>// The number of bits at a position in the bitmap</p> <p>#define NUM_BITS 8</p> <p>Initialize the size. Index, offset and process id of bitmap. All variable are declared as static as there value is not changing throughout the program.</p> <p>// The bitmap of pids</p> <p>static unsigned char <b>*</b>s_bitmap <b>=</b> <b>NULL</b><b>;</b></p> <p>// The size of the bitmap</p> <p>static int s_size <b>=</b> <b>-</b>1<b>;</b></p> <p>// The current index into the bitmap</p> <p>static int s_index <b>=</b> <b>-</b>1<b>;</b></p> <p>// The current offset into the index of the bitmap</p> <p>static int s_offset <b>=</b> <b>-</b>1<b>;</b></p> <p>// The last assigned pid</p> <p>static int s_pid <b>=</b> <b>-</b>1<b>;</b></p> <p>Allocate the map for process ids calculating the size of bitmap that is required.</p> <p>//Allocate the map for the pids. </p> <p>int allocate_map<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap need to be allocated?</p> <p> <b>if</b> <b>(!</b>s_bitmap<b>)</b> </p> <p> <b>{</b></p> <p> // Calculate the size of the bitmap required</p> <p> s_size <b>=</b> <b>(</b>int<b>)</b> <b>((</b>double<b>)</b> <b>(</b>MAX_PID</p> <p> <b>-</b> MIN_PID <b>+</b> 1</p> <p> <b>+</b> NUM_BITS <b>-</b> 1<b>)</b></p> <p> <b>/</b> NUM_BITS<b>);</b></p> <p> </p> <p> // Allocate the bitmap</p> <p> s_bitmap <b>=</b> <b>(</b>__typeof__<b>(</b>s_bitmap<b>))</b> malloc<b>(</b>s_size<b>);</b></p> <p> <b>}</b></p> <p> </p> <p> // Does the bitmap exist?</p> <p> <b>if</b> <b>(</b>s_bitmap<b>)</b> </p> <p> <b>{</b></p> <p> // Initialize the variables</p> <p> s_index <b>=</b> s_offset <b>=</b> 0<b>;</b></p> <p> s_pid <b>=</b> MIN_PID <b>-</b> 1<b>;</b></p> <p> <b>return</b> 1<b>;</b></p> <p> <b>}</b> <b>else</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b> </p> <p>//Release the bitmap </p> <p>void release_map<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap exist?</p> <p> <b>if</b> <b>(</b>s_bitmap<b>)</b> </p> <p> </div>
<h2>Step-4</h2>
<div class="answer"> <b>{</b></p> <p> // Free it & deinitialize the variables</p> <p> free<b>(</b>s_bitmap<b>);</b></p> <p> s_bitmap <b>=</b> <b>NULL</b><b>;</b></p> <p> s_index <b>=</b> s_offset <b>=</b> s_pid <b>=</b> <b>-</b>1<b>;</b></p> <p> <b>}</b></p> <p> <b>}</b> </p> <p>Allocate a pid in a range. It assumes that bitmap is valid. While loop is used to execute the condition until pindex is less then size. </p> <p>static int allocate_pid_range<b>(</b>int <b>*</b>pindex<b>,</b></p> <p> const int size<b>)</b></p> <p> <b>{</b> </p> <p> // While the index is less than the size</p> <p> <b>while</b> <b>(*</b>pindex <b><</b> size<b>)</b> </p> <p> <b>{</b></p> <p> // While the offset within an element</p> <p> // is less than the number of bits</p> <p> <b>while</b> <b>(</b>s_offset <b><</b> NUM_BITS<b>)</b> </p> <p> <b>{</b> </p> <p> </p> <p> // Increment the pid</p> <p> s_pid<b>++;</b></p> <p> </p> <p> // Did the pid exceed the maximum?</p> <p> <b>if</b> <b>(</b>s_pid <b>></b> MAX_PID<b>)</b> </p> <p> <b>{</b></p> <p> // Reset the pid and the offset</p> <p> s_pid <b>=</b> MIN_PID <b>-</b> 1<b>;</b></p> <p> s_offset <b>=</b> 0<b>;</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b></p> <p> // Is the offset free?</p> <p> <b>if</b> <b>(!(</b>s_bitmap<b>[*</b>pindex<b>]</b></p> <p> <b>&</b> <b>(</b>1u <b><<</b> s_offset<b>)))</b> </p> <p> <b>{</b></p> <p> // Fill the offset</p> <p> s_bitmap<b>[*</b>pindex<b>]</b> <b>|=</b> 1u <b><<</b> s_offset<b>;</b></p> <p> </p> <p> // Increment the offset</p> <p> s_offset<b>++;</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b></p> <p> </p> <p> // Increment the offset</p> <p> s_offset<b>++;</b></p> <p> <b>}</b></p> <p> </p> <p> // Reset the offset</p> <p> s_offset <b>=</b> 0<b>;</b></p> <p> </p> <p> // Increment the index</p> <p> <b>(*</b>pindex<b>)++;</b></p> <p> <b>}</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b> </p> <p>In allocate_pid function allocate the pid from current index to size of bitmap. If pid is allocated then ret value will be 0 otherwise less than 0.</p> <p>//Allocate a pid. </p> <p>int allocate_pid<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap exist?</p> <p> <b>if</b> <b>(</b>s_bitmap<b>)</b> </p> <p> <b>{</b></p> <p> // Try to allocate a pid from the current index</p> <p> // to the size of the bitmap</p> <p> int index <b>=</b> s_index<b>;</b></p> <p> int ret <b>=</b> allocate_pid_range<b>(&</b>index<b>,</b> s_size<b>);</b></p> <p> </p> <p> // Could a pid be allocated?</p> <p> <b>if</b> <b>(</b>ret <b><</b> 0<b>)</b> </p> <p> <b>{</b></p> <p> // Reset the index and try again</p> <p> index <b>=</b> 0<b>;</b></p> <p> ret <b>=</b> allocate_pid_range<b>(&</b>index<b>,</b> s_index<b>);</b></p> <p> <b>}</b></p> <p> // Was a pid successfully allocated?</p> <p> <b>if</b> <b>(</b>ret <b>==</b> 0<b>)</b> </p> <p> <b>{</b></p> <p> // Update the index</p> <p> s_index <b>=</b> index<b>;</b></p> <p> // Return the pid</p> <p> <b>return</b> s_pid<b>;</b></p> <p> <b>}</b></p> <p> <b>}</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b> </p> <p>//Release an allocated pid. </p> <p>void release_pid<b>(</b>int pid<b>)</b></p> <p> <b>{</b> </p> <p> // Does the bitmap exist and is the pid valid?</p> <p> <b>if</b> <b>(</b>s_bitmap <b>&&</b> pid <b>>=</b> MIN_PID <b>&&</b> pid <b><=</b> MAX_PID<b>)</b> </p> <p> <b>{</b></p> <p> // Subtract MIN_PID so it can be</p> <p> </div>
<h2>Step-5</h2>
<div class="answer"> // used to access the bitmap</p> <p> pid <b>-=</b> MIN_PID<b>;</b></p> <p> </p> <p> // Clear the entry for the pid in the bitmap</p> <p> s_bitmap<b>[</b>pid <b>/</b> NUM_BITS<b>]</b> </p> <p> <b>&=</b> <b>~(</b>1u <b><<</b> <b>(</b>pid <b>%</b> NUM_BITS<b>));</b></p> <p> <b>}</b></p> <p> <b>}</b> </p> </div>
<h2>Step-6</h2>
<div class="answer"> <p>//Importing header files</p> <p>#include <stdio.h></p> <p>#include "3-20PP.h"</p> <p>int main<b>(</b>void<b>)</b></p> <p> <b>{</b> </p> <p> // Allocate the bitmap</p> <p> <b>if</b> <b>(</b>allocate_map<b>()</b> <b>!=</b> 1<b>)</b> <b>{</b></p> <p> fputs<b>(</b>"allocate_map blew\n"<b>,</b> stdout<b>);</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> <b>}</b></p> <p> // Allocate 10 pids</p> <p> int pida<b>[</b>10<b>],</b> i<b>;</b></p> <p> <b>for</b> <b>(</b>i <b>=</b> 0<b>;</b> i <b><</b> <b>sizeof</b><b>(</b>pida<b>)</b> <b>/</b> <b>sizeof</b><b>(*</b>pida<b>);</b> i<b>++)</b> <b>{</b></p> <p> pida<b>[</b>i<b>]</b> <b>=</b> allocate_pid<b>();</b></p> <p> printf<b>(</b>"allocate_pid %d\n"<b>,</b> pida<b>[</b>i<b>]);</b></p> <p> <b>}</b></p> <p> // Release 5 pids</p> <p> <b>for</b> <b>(</b>i <b>=</b> 0<b>;</b> i <b><</b> <b>sizeof</b><b>(</b>pida<b>)</b> <b>/</b> <b>sizeof</b><b>(*</b>pida<b>);</b> i <b>+=</b> 2<b>)</b> <b>{</b></p> <p> release_pid<b>(</b>pida<b>[</b>i<b>]);</b></p> <p> <b>}</b></p> <p> fputc<b>(</b>'\n'<b>,</b> stdout<b>);</b></p> <p> // Allocate 10 pids</p> <p> <b>for</b> <b>(</b>i <b>=</b> 0<b>;</b> i <b><</b> <b>sizeof</b><b>(</b>pida<b>)</b> <b>/</b> <b>sizeof</b><b>(*</b>pida<b>);</b> i <b>+=</b> 2<b>)</b> <b>{</b></p> <p> pida<b>[</b>i<b>]</b> <b>=</b> allocate_pid<b>();</b></p> <p> printf<b>(</b>"allocate_pid %d\n"<b>,</b> pida<b>[</b>i<b>]);</b></p> <p> <b>}</b></p> <p> release_map<b>();</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b> </p> </div>
<h2>Step-7</h2>
<div class="answer"> <p> <b>Sample Output:</b> </p> <p>allocate_pid 300</p> <p>allocate_pid 301</p> <p>allocate_pid 302</p> <p>allocate_pid 303</p> <p>allocate_pid 304</p> <p>allocate_pid 305</p> <p>allocate_pid -1</p> <p>allocate_pid -1</p> <p>allocate_pid -1</p> <p>allocate_pid -1</p> <p>allocate_pid 300</p> <p>allocate_pid 302</p> <p>allocate_pid 304</p> <p>allocate_pid -1</p> <p>allocate_pid -1</p></div>
