<h2>Step-1</h2>
<div class="answer"> <p> <b>Program Plan:</b> </p> <p> <b> </b> </p> <p>• Create an index for reading and writing files from pipe.</p> <p>• Write to a file descriptor from a buffer of size bytes using function write_buffer.<b> </b></p> <p>• Read from a file descriptor into a buffer of size bytes using function read_buffer. </p> <p>• Write a main() function. It uses fork function and also calls other function to read and write file. <b> </b></p> </div>
<h2>Step-2</h2>
<div class="answer"> <p> <b>Program:</b> </p> <p>//Include the header files for performing the operations.</p> <p>#include <stdio.h></p> <p>#include <unistd.h></p> <p>#include <errno.h></p> <p>#include <string.h></p> <p>#include <sys/types.h></p> <p>#include <sys/stat.h></p> <p>#include <fcntl.h></p> <p>#include <sys/wait.h></p> <p>// The index of the file descriptor for reading from a pipe</p> <p>const int READ_END <b>=</b> 0<b>;</b></p> <p>// The index of the file descriptor for writing from a pipe</p> <p>const int WRITE_END <b>=</b> 1<b>;</b></p> <p>// The size of the buffer</p> <p>const int BUFFER_SIZE <b>=</b> 512<b>;</b></p> </div>
<h2>Step-3</h2>
<div class="answer"> <p>//Write to a file descriptor from a buffer of size bytes </p> <p> </p> <p>ssize_t write_buffer<b>(</b>int fd<b>,</b> char <b>*</b>buffer<b>,</b> size_t size<b>)</b></p> <p> <b>{</b> </p> <p> <b>if</b> <b>(</b>fd <b><</b> 0 <b>||</b> <b>!</b>buffer <b>||</b> size <b><</b> 0<b>)</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> // While there are bytes left to send</p> <p> <b>while</b> <b>(</b>size <b>></b> 0<b>)</b> <b>{</b></p> <p> // Try to write size bytes</p> <p> ssize_t sent <b>=</b> write<b>(</b>fd<b>,</b> buffer<b>,</b> size<b>);</b></p> <p> // Was there an error?</p> <p> <b>if</b> <b>(</b>sent <b><</b> 0<b>)</b> <b>{</b></p> <p> int err <b>=</b> errno<b>;</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "write error %d - %s\n"<b>,</b></p> <p> err<b>,</b> strerror<b>(</b>err<b>));</b></p> <p> <b>return</b> <b>-</b>2<b>;</b></p> <p> <b>}</b></p> <p> // Update size and buffer</p> <p> size <b>-=</b> sent<b>;</b></p> <p> buffer <b>+=</b> sent<b>;</b></p> <p> <b>}</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b> </p> </div>
<h2>Step-4</h2>
<div class="answer"> <p>Read from a file descriptor into a buffer of size bytes. Read_buffer function is created to initialized index and attempt to read (size - index) bytes into buffer at offset index. Read from a file descriptor into a buffer of size bytes. </p> </div>
<h2>Step-5</h2>
<div class="answer"> <p>ssize_t read_buffer<b>(</b>int fd<b>,</b> char <b>*</b>buffer<b>,</b> size_t size<b>)</b></p> <p> <b>{</b> </p> <p> // The index into the buffer</p> <p> ssize_t index<b>;</b></p> <p> <b>if</b> <b>(</b>fd <b><</b> 0 <b>||</b> <b>!</b>buffer <b>||</b> size <b><</b> 0<b>)</b></p> <p> <b>return</b> <b>-</b>1<b>;</b></p> <p> // Initialize the index</p> <p> index <b>=</b> 0<b>;</b></p> <p> // While the index into the buffer is less</p> <p> // than its size</p> <p> <b>while</b> <b>(</b>index <b><</b> size<b>)</b> <b>{</b></p> <p> // Attempt to read (size - index) bytes</p> <p> // into buffer at offset index</p> <p> ssize_t bytes_read <b>=</b> read<b>(</b>fd<b>,</b> buffer <b>+</b> index<b>,</b></p> <p> size <b>-</b> index<b>);</b></p> <p> // If nothing left then break out of the loop</p> <p> <b>if</b> <b>(</b>bytes_read <b>==</b> 0<b>)</b></p> <p> <b>break</b><b>;</b></p> <p> // Has an error occurred?</p> <p> <b>if</b> <b>(</b>bytes_read <b><</b> 0<b>)</b> <b>{</b></p> <p> int err <b>=</b> errno<b>;</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "read blew %d - %s\n"<b>,</b></p> <p> err<b>,</b> strerror<b>(</b>err<b>));</b></p> <p> <b>return</b> <b>-</b>2<b>;</b></p> <p> <b>}</b></p> <p> // Add the bytes read to update the index</p> <p> index <b>+=</b> bytes_read<b>;</b></p> <p> <b>}</b></p> <p> <b>return</b> index<b>;</b></p> <p> <b>}</b> </p> </div>
<h2>Step-6</h2>
<div class="answer"> <p>main() function is defined that defines files descriptor for first and second pipe and creating them. A child process is forked to run different pipelines.</p> <p>//The startup function </p> <p>int main<b>(</b>int argc<b>,</b> char <b>**</b>argv<b>)</b></p> <p> <b>{</b> </p> <p> </div>
<h2>Step-7</h2>
<div class="answer"> // The file descriptors for the pipe</p> <p> int fd<b>[</b>2<b>];</b></p> <p> // The buffer used to store data</p> <p> char buffer<b>[</b>BUFFER_SIZE<b>];</b></p> <p> // Name of the source file</p> <p> char <b>*</b>source<b>;</b></p> <p> // Name of the destination file</p> <p> char <b>*</b>destination<b>;</b></p> <p> // Were we invoked with the right arguments?</p> <p> <b>if</b> <b>(</b>argc <b>!=</b> 3<b>)</b> <b>{</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "%s [source file] "</p> <p> "[destination file]\n"<b>,</b> <b>*</b>argv<b>);</b></p> <p> <b>return</b> 1<b>;</b></p> <p> <b>}</b></p> <p> // Initialize the source & destination filenames</p> <p> source <b>=</b> argv<b>[</b>1<b>];</b></p> <p> destination <b>=</b> argv<b>[</b>2<b>];</b></p> <p> // Create the pipe</p> <p> <b>if</b> <b>(</b>pipe<b>(</b>fd<b>)</b> <b><</b> 0<b>)</b> <b>{</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "pipe blew %d\n"<b>,</b> errno<b>);</b></p> <p> <b>return</b> 2<b>;</b></p> <p> <b>}</b></p> <p> // Fork off a process</p> <p> pid_t pid <b>=</b> fork<b>();</b></p> <p> // Are we in the parent process?</p> <p> <b>if</b> <b>(</b>pid <b>></b> 0<b>)</b> <b>{</b></p> <p> int fd_source<b>,</b> status<b>;</b></p> <p> size_t bytes_read<b>;</b></p> <p> // Close the reading end of the pipe</p> <p> close<b>(</b>fd<b>[</b>READ_END<b>]);</b></p> <p> // Open the source file</p> <p> fd_source <b>=</b> open<b>(</b>source<b>,</b> O_RDONLY<b>);</b></p> <p> <b>if</b> <b>(</b>fd_source <b><</b> 0<b>)</b> <b>{</b></p> <p> int err <b>=</b> errno<b>;</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "Couldn't open file '%s' "</p> <p> "for reading - %d, %s\n"<b>,</b> source<b>,</b></p> <p> err<b>,</b> strerror<b>(</b>err<b>));</b></p> <p> close<b>(</b>fd<b>[</b>WRITE_END<b>]);</b></p> <p> wait<b>(</b><b>NULL</b><b>);</b></p> <p> <b>return</b> 3<b>;</b></p> <p> <b>}</b></p> <p> // While bytes can be read from the file</p> <p> <b>while</b> <b>((</b>bytes_read <b>=</b> read<b>(</b>fd_source<b>,</b></p> <p> buffer<b>,</b></p> <p> <b>sizeof</b><b>(</b>buffer<b>)))</b></p> <p> <b>></b> 0<b>)</b></p> <p> // Write the data read into the writing</p> <p> // end of the pipe</p> <p> <b>if</b> <b>(</b>write_buffer<b>(</b>fd<b>[</b>WRITE_END<b>],</b></p> <p> buffer<b>,</b> bytes_read<b>)</b> <b><</b> 0<b>)</b></p> <p> <b>break</b><b>;</b></p> <p> // Close the source file descriptor</p> <p> close<b>(</b>fd_source<b>);</b></p> <p> // Close the writing end of the pipe</p> <p> close<b>(</b>fd<b>[</b>WRITE_END<b>]);</b></p> <p> // Wait for the child to exit</p> <p> <b>if</b> <b>(</b>wait<b>(&</b>status<b>)</b> <b>>=</b> 0<b>)</b> <b>{</b></p> <p> // Was the child killed by a signal?</p> <p> <b>if</b> <b>(</b>WIFSIGNALED<b>(</b>status<b>))</b> <b>{</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "Child process was "</p> <p> "terminated by signal %d\n"<b>,</b></p> <p> WTERMSIG<b>(</b>status<b>));</b></p> <p> <b>return</b> 4<b>;</b></p> <p> <b>}</b></p> <p> // Did the child not exit with code 0?</p> <p> <b>if</b> <b>(</b>WEXITSTATUS<b>(</b>status<b>)</b> <b>!=</b> 0<b>)</b> </p> <p> <b>return</b> 5<b>;</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b> <b>else</b></p> <p> <b>return</b> 6<b>;</b></p> <p> <b>}</b></p> <p> // Is it the child process?</p> <p> <b>else</b> <b>if</b> <b>(</b>pid <b>==</b> 0<b>)</b> <b>{</b></p> <p> ssize_t bytes_read<b>;</b></p> <p> int fd_destination<b>;</b></p> <p> // Close the writing end of the pipe</p> <p> close<b>(</b>fd<b>[</b>WRITE_END<b>]);</b></p> <p> // Create the destination file</p> <p> fd_destination <b>=</b> open<b>(</b>destination<b>,</b></p> <p> O_CREAT <b>|</b> O_WRONLY <b>|</b> O_TRUNC<b>,</b></p> <p> S_IRUSR<b>);</b></p> <p> <b>if</b> <b>(</b>fd_destination <b><</b> 0<b>)</b> <b>{</b></p> <p> int err <b>=</b> errno<b>;</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "Couldn't open "</p> <p> "destination file '%s' - %d, %s\n"<b>,</b></p> <p> destination<b>,</b> err<b>,</b> strerror<b>(</b>err<b>));</b></p> <p> close<b>(</b>fd<b>[</b>READ_END<b>]);</b></p> <p> <b>return</b> 1<b>;</b></p> <p> <b>}</b></p> <p> // While bytes can be read from the reading</p> <p> // end of the pipe</p> <p> <b>while</b> <b>((</b>bytes_read <b>=</b> read_buffer<b>(</b>fd<b>[</b>READ_END<b>],</b></p> <p> buffer<b>,</b></p> <p> <b>sizeof</b><b>(</b>buffer<b>)))</b></p> <p> <b>></b> 0<b>)</b></p> <p> // Write the bytes read to the file</p> <p> write<b>(</b>fd_destination<b>,</b> buffer<b>,</b> bytes_read<b>);</b></p> <p> // Close the destination file descriptor</p> <p> close<b>(</b>fd_destination<b>);</b></p> <p> // Close the reading end of the pipe</p> <p> </div>
<h2>Step-8</h2>
<div class="answer"> close<b>(</b>fd<b>[</b>READ_END<b>]);</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b></p> <p> // Did the system call fork malfunction?</p> <p> <b>else</b> <b>{</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "fork blew %d\n"<b>,</b> errno<b>);</b></p> <p> // Close the pipe</p> <p> close<b>(</b>fd<b>[</b>WRITE_END<b>]);</b></p> <p> close<b>(</b>fd<b>[</b>READ_END<b>]);</b></p> <p> <b>return</b> 7<b>;</b></p> <p> <b>}</b></p> <p> <b>}</b> </p> </div>
<h2>Step-9</h2>
<div class="answer"> <p> <b>Sample Output:</b> </p> <p>[abc@localhost 3]$ fortune | tee 3-27PP.source</p> <p>My opinions may have changed, but not the fact that I am right.</p> <p>[abc@localhost 3]$ ./3-27PP 3-27PP.source 3-27PP.destination</p> <p>[abc@localhost 3]$ cat 3-27PP.destination</p> <p>My opinions may have changed, but not the fact that I am right.</p></div>
