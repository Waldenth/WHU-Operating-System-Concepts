<h2>Step-1</h2>
<div class="answer"> <p> <b>Program Plan:</b> </p> <p>• Two modules Producer and Consumer Created.</p> <p>• Common header files are included in both the modules.</p> <p>• Method printLastError() print out the message and then print out the string corresponding to the last error that occurred.</p> <p>• Method printLastError() takes two argument and print the last error.</p> <p>• Method writeCollatz()is used to sequence the shared memory.</p> <p>• Map the view of the file mapping into the address space.</p> <p>• Allow the read/write access.</p> <p>• Return the sequence of number from the shared memory. </p> </div>
<h2>Step-2</h2>
<div class="answer"> <p> <b>Common.h</b> </p> <p>#ifndef __COMMON_H</p> <p>#define __COMMON_H</p> <p>// Print out the last error</p> <p>extern void printLastError<b>(</b>const char <b>*</b>message<b>,</b></p> <p> const DWORD lastError<b>);</b></p> <p>#endif</p> </div>
<h2>Step-3</h2>
<div class="answer"> <p> <b>Common.c</b> </p> <p>#include <windows.h></p> <p>#include <stdio.h></p> <p>#include "common.h"</p> <p>Print out the message and then print out the string corresponding to the last error that occurred.</p> <p>void printLastError<b>(</b>const char <b>*</b>message<b>,</b></p> <p> const DWORD lastError<b>)</b></p> <p> <b>{</b> </p> <p> // Pointer to the buffer that will</p> <p> // contain the string for lastError</p> <p> LPTSTR pTemp <b>=</b> <b>NULL</b><b>;</b></p> <p> // The size of the buffer allocated to pTemp</p> <p> DWORD retSize<b>;</b></p> <p> // Was a message passed?</p> <p> <b>if</b> <b>(</b>message<b>)</b></p> <p> // Print it out</p> <p> fputs<b>(</b>message<b>,</b> stderr<b>);</b></p> <p> // Format pTemp with the error for lastError</p> <p> retSize<b>=</b>FormatMessage<b>(</b></p> <p> // Allocate a buffer</p> <p> FORMAT_MESSAGE_ALLOCATE_BUFFER</p> <p> // Search the system message-table</p> <p> // resource for the message</p> <p> <b>|</b> FORMAT_MESSAGE_FROM_SYSTEM</p> <p> // The arguments parameter is a</p> <p> // pointer to an array of values</p> <p> <b>|</b> FORMAT_MESSAGE_ARGUMENT_ARRAY<b>,</b></p> <p> // Ignored as none of the relevant flags are set</p> <p> <b>NULL</b><b>,</b></p> <p> // The error that occurred</p> <p> lastError<b>,</b></p> <p> // Use default custom locale language</p> <p> LANG_NEUTRAL<b>,</b></p> <p> // Point to the buffer for the error message</p> <p> <b>(</b>LPTSTR<b>)</b> <b>&</b>pTemp<b>,</b></p> <p> // The size of the buffer</p> <p> 0<b>,</b></p> <p> // No arguments are passed</p> <p> <b>NULL</b><b>);</b></p> <p>// Does pTemp have a valid value?</p> <p> <b>if</b> <b>(</b>pTemp<b>)</b> </p> <p> <b>{</b></p> <p> // Was the returned size positive?</p> <p> <b>if</b> <b>(</b>retSize <b>></b> 0<b>)</b></p> <p> // Print out pTemp</p> <p> fputws<b>(</b>pTemp<b>,</b> stderr<b>);</b></p> <p> // Free pTemp</p> <p> LocalFree<b>((</b>HLOCAL<b>)</b> pTemp<b>);</b></p> <p> <b>}</b></p> <p> <b>}</b> </p> <p> <b> </div>
<h2>Step-4</h2>
<div class="answer">Producer.c</b> </p> <p>#include <windows.h></p> <p>#include <stdio.h></p> <p>#include "common.h"</p> <p>// The name of the memory mapping</p> <p>const WCHAR MAPPING_NAME<b>[]</b> <b>=</b> L"13258-9-40PP"<b>;</b></p> <p>const WCHAR FILE_NAME<b>[]</b> <b>=</b> L"13258-9-40PP.txt"<b>;</b></p> <p>const int MAP_SIZE <b>=</b> 4096<b>;</b></p> <p>// Process the number input to the program</p> <p>static void processNumber<b>(</b>const int iNumber<b>,</b> char</p> <p> <b>**</b>ppAddress<b>, </b>int <b>*</b>pSize<b>);</b></p> <p>// Write the Collatz sequence to the shared memory</p> <p>static void writeCollatz<b>(</b>int iNumber<b>,</b> char <b>**</b>ppAddress<b>,</b></p> <p> int <b>*</b>pSize<b>);</b></p> <p>The startup function.</p> <p>int main<b>(</b>int argc<b>,</b> char<b>*</b> argv<b>[])</b></p> <p> <b>{</b> </p> <p> // The handle of the actual file</p> <p> HANDLE hFile<b>;</b></p> <p> // The handle of the file to be mapped</p> <p> HANDLE hMapFile<b>;</b></p> <p> // The address of the shared memory</p> <p> LPVOID lpMapAddress<b>;</b></p> <p> // The number of Collatz numbers to generate</p> <p> int iNumber<b>;</b></p> <p> // The size of the shared memory</p> <p> int iSize<b>;</b></p> <p> <b>if</b> <b>(</b>argc <b>!=</b> 2<b>)</b> <b>{</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "%s +ve-integer\n"<b>,</b> <b>*</b>argv<b>);</b></p> <p> <b>return</b> 1<b>;</b></p> <p> <b>}</b></p> <p> Get the number of Collatz numbers to be generated.</p> <p> iNumber <b>=</b> atoi<b>(</b>argv<b>[</b>1<b>]);</b></p> <p> <b>if</b> <b>(</b>iNumber <b><=</b> 0<b>)</b> <b>{</b></p> <p> fprintf<b>(</b>stderr<b>,</b> "%s +ve-integer\n"<b>,</b> <b>*</b>argv<b>);</b></p> <p> <b>return</b> 2<b>;</b></p> <p> <b>}</b></p> <p> // Create a file on disk</p> <p> hFile <b>=</b> CreateFile<b>(</b></p> <p> // The name of the file</p> <p> FILE_NAME<b>,</b></p> <p> // Allow read/write access</p> <p> GENERIC_READ <b>|</b> GENERIC_WRITE<b>,</b></p> <p> // Don't allow sharing</p> <p> 0<b>,</b></p> <p> // Use the default security security attributes</p> <p> <b>NULL</b><b>,</b></p> <p> // Always create the file</p> <p> CREATE_ALWAYS<b>,</b></p> <p> // Use the normal attributes for the file</p> <p> FILE_ATTRIBUTE_NORMAL<b>,</b> <b>NULL</b><b>);</b></p> <p> <b>if</b> <b>(</b>hFile <b>==</b> INVALID_HANDLE_VALUE<b>)</b> <b>{</b></p> <p> printLastError<b>(</b>"CreateFile didn't work.\n"<b>,</b></p> <p> GetLastError<b>());</b></p> <p> <b>return</b> 3<b>;</b></p> <p> <b>}</b></p> <p>Create a file mapping, which handle to the disk file to be mapped and use the default security attributes allow read/write access to the mapped pages the high DWORD of the size of the mapping the low DWORD of the size of the mapping the name of the mapping.</p> <p> hMapFile <b>=</b> CreateFileMapping<b>(</b>hFile<b>, </b><b>NULL</b><b>,</b>PAGE_READWRITE<b>,</b></p> <p> 0<b>,(</b>DWORD<b>)</b> MAP_SIZE<b>,</b>MAPPING_NAME<b>);</b></p> <p> <b>if</b> <b>(</b>hMapFile <b>==</b> <b>NULL</b><b>)</b> <b>{</b></p> <p> printLastError<b>(</b>"CreateFileMapping didn't "</p> <p> "work.\n"<b>,</b> GetLastError<b>());</b></p> <p> // Close the handle to the disk file</p> <p> CloseHandle<b>(</b>hFile<b>);</b></p> <p> <b>return</b> 4<b>;</b></p> <p> <b>}</b></p> <p> Map the view of the file mapping into the address space.</p> <p> lpMapAddress <b>=</b> MapViewOfFile<b>(</b>hMapFile<b>,</b></p> <p> <b> </b>FILE_MAP_ALL_ACCESS<b>,</b>0<b>,</b>0<b>,</b>0<b>);</b></p> <p> <b>if</b> <b>(</b>lpMapAddress <b>==</b> <b>NULL</b><b>)</b> </p> <p> <b>{</b> </p> <p> printLastError<b>(</b>"MapViewOfFile didn't work\n"<b>,</b></p> <p> GetLastError<b>());</b></p> <p> // Close the handle to the disk file</p> <p> CloseHandle<b>(</b>hFile<b>);</b></p> <p> // Close the handle to the mapped file</p> <p> CloseHandle<b>(</b>hMapFile<b>);</b></p> <p> <b>return</b> 5<b>;</b></p> <p> <b>}</b></p> <p> // Set the size of the shared memory</p> <p> // to be passed to processNumber</p> <p> iSize <b>=</b> MAP_SIZE<b>;</b></p> <p> // Generate the Collatz numbers</p> <p> processNumber<b>(</b>iNumber<b>,</b> <b>(</b>char <b>**)</b> <b>&</b>lpMapAddress<b>,</b></p> <p> <b>&</b>iSize<b>);</b></p> <p> // Wait for the consumer</p> <p> printf<b>(</b>"Generated %d numbers. Enter a number to "</p> <p> "continue: "<b>,</b> iNumber<b>);</b></p> <p> scanf_s<b>(</b>"%d"<b>,</b> <b>&</b>iNumber<b>);</b></p> <p> // Unmap the view</p> <p> UnmapViewOfFile<b>(</b>lpMapAddress<b>);</b></p> <p> // Close the handle to the disk file</p> <p> CloseHandle<b>(</b>hFile<b>);</b></p> <p> // Close the handle to the mapped file</p> <p> CloseHandle<b>(</b>hMapFile<b>);</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b> </p> <p>void processNumber<b>(</b>const int iNumber<b>,</b> char <b>**</b>ppAddress<b>,</b></p> <p> int <b>*</b>pSize<b>)</b></p> <p> <b>{</b> </p> <p> int iIndex<b>;</b></p> <p> <b>for</b> <b>(</b>iIndex <b>=</b> 1<b>;</b> iIndex <b><=</b> iNumber<b>;</b> iIndex<b>++)</b></p> <p> writeCollatz<b>(</b>iIndex<b>,</b> ppAddress<b>,</b> pSize<b>);</b></p> <p> <b>}</b> </p> <p>void writeCollatz<b>(</b>int iNumber<b>,</b> char <b>**</b>ppAddress<b>,</b></p> <p> int <b>*</b>pSize<b>)</b></p> <p> <b>{</b> </p> <p> int iWriteSize<b>;</b></p> <p> <b>if</b> <b>(</b>iNumber <b><</b> 0 <b>||</b> <b>!</b>ppAddress <b>||</b> <b>!</b>pSize</p> <p> <b>||</b> <b>!*</b>ppAddress <b>||</b> <b>*</b>pSize <b><=</b> 0<b>)</b></p> <p> <b>return</b><b>;</b></p> <p> <b>while</b> <b>(</b>iNumber <b>></b> 1<b>)</b> <b>{</b></p> <p> iWriteSize <b>=</b> _snprintf_s<b>(*</b>ppAddress<b>,</b> <b>*</b>pSize<b>,</b></p> <p> _TRUNCATE<b>,</b></p> <p> "%d\n"<b>,</b> iNumber<b>);</b></p> <p> // Check for iWritesize.</p> <p> <b>if</b> <b>(</b>iWriteSize <b><</b> 0<b>)</b> <b>{</b></p> <p> <b>*</b>ppAddress <b>+=</b> <b>*</b>pSize<b>;</b></p> <p> <b>*</b>pSize <b>=</b> 0<b>;</b></p> <p> <b>return</b><b>;</b></p> <p> <b>}</b></p> <p> <b>*</b>ppAddress <b>+=</b> iWriteSize<b>;</b></p> <p> <b>*</b>pSize <b>-=</b> iWriteSize<b>;</b></p> <p> iNumber <b>=</b> <b>(</b>iNumber <b>%</b> 2<b>)</b> <b>?</b> <b>(</b>3 <b>*</b> iNumber <b>+</b> 1<b>)</b></p> <p> <b>:</b> <b>(</b>iNumber <b>/</b> 2<b>);</b></p> <p> <b>}</b></p> <p> iWriteSize <b>=</b> _snprintf_s<b>(*</b>ppAddress<b>,</b> <b>*</b>pSize<b>,</b></p> <p> _TRUNCATE<b>,</b></p> <p> "%d\n"<b>,</b> iNumber<b>);</b></p> <p> <b>if</b> <b>(</b>iWriteSize <b><</b> 0<b>)</b> <b>{</b></p> <p> <b>*</b>ppAddress <b>+=</b> <b>*</b>pSize<b>;</b></p> <p> <b>*</b>pSize <b>=</b> 0<b>;</b></p> <p> <b>}</b> <b>else</b> <b>{</b></p> <p> <b>*</b>ppAddress <b>+=</b> iWriteSize<b>;</b></p> <p> <b>*</b>pSize <b>-=</b> iWriteSize<b>;</b></p> <p> <b>}</b></p> <p> <b>}</b> </p> </div>
<h2>Step-5</h2>
<div class="answer"> <p> <b>Sample Output:</b> </p> <p>D:\13258\13258-9-40PP>Producer\Debug\Producer.exe 5</p> <p>Generated 5 numbers. Enter a number to continue: 1</p> <p> <b> </div>
<h2>Step-6</h2>
<div class="answer">Consumer.c</b> </p> <p>#include <windows.h></p> <p>#include <stdio.h></p> <p>#include "common.h"</p> <p>// The name of the memory mapping</p> <p>const WCHAR MAPPING_NAME<b>[]</b> <b>=</b> L"13258-9-40PP"<b>;</b></p> <p>int main<b>(</b>int argc<b>,</b> char<b>*</b> argv<b>[])</b></p> <p> <b>{</b> </p> <p> // The handle of the file to be mapped</p> <p> HANDLE hMapFile<b>;</b></p> <p> // The address of the shared memory</p> <p> LPVOID lpMapAddress<b>;</b></p> <p> // Open a named file mapping object</p> <p> hMapFile <b>=</b> OpenFileMapping<b>(</b></p> <p> // Allow read/write access</p> <p> FILE_MAP_ALL_ACCESS<b>,</b></p> <p> // No inheritance</p> <p> FALSE<b>,</b></p> <p> // The name of the mapping</p> <p> MAPPING_NAME<b>);</b></p> <p> <b>if</b> <b>(</b>hMapFile <b>==</b> <b>NULL</b><b>)</b> <b>{</b></p> <p> printLastError<b>(</b>"OpenFileMapping didn't "</p> <p> "work.\n"<b>,</b> GetLastError<b>());</b></p> <p> <b>return</b> 1<b>;</b></p> <p> <b>}</b></p> <p> // Map the view of the file mapping</p> <p> // into the address space</p> <p> lpMapAddress <b>=</b> MapViewOfFile<b>(</b></p> <p> // The handle of the object to map</p> <p> hMapFile<b>,</b></p> <p> // Allow read/write access</p> <p> FILE_MAP_ALL_ACCESS<b>,</b></p> <p> 0<b>,</b> // Map the</p> <p> 0<b>,</b> // whole file at</p> <p> 0<b>);</b> // whatever offset</p> <p> <b>if</b> <b>(</b>lpMapAddress <b>==</b> <b>NULL</b><b>)</b> <b>{</b></p> <p> printLastError<b>(</b>"MapViewOfFile didn't work\n"<b>,</b></p> <p> GetLastError<b>());</b></p> <p> // Close the handle to the mapped file</p> <p> CloseHandle<b>(</b>hMapFile<b>);</b></p> <p> <b>return</b> 2<b>;</b></p> <p> <b>}</b></p> <p> fputs<b>((</b>char <b>*)</b> lpMapAddress<b>,</b> stdout<b>);</b></p> <p> UnmapViewOfFile<b>(</b>lpMapAddress<b>);</b></p> <p> // Close the handle to the mapped file</p> <p> CloseHandle<b>(</b>hMapFile<b>);</b></p> <p> <b>return</b> 0<b>;</b></p> <p> <b>}</b> </p> </div>
<h2>Step-7</h2>
<div class="answer"> <p> <b>Sample Output:</b> </p> <p>:\13258\13258-9-40PP>Consumer\Debug\Consumer.exe</p> <p>1</p> <p>2</p> <p>1</p> <p>3</p> <p>10</p> <p>5</p> <p>16</p> <p>8</p> <p>4</p> <p>2</p> <p>1</p> <p>4</p> <p>2</p> <p>1</p> <p>5</p> <p>16</p> <p>8</p> <p>4</p> <p>2</p> <p>1</p></div>
